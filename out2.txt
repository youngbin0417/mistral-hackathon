PASS __tests__/api/config.test.ts
FAIL __tests__/api/sfx.test.ts
  â— Test suite failed to run

    ReferenceError: Request is not defined

       9 |         }
      10 |
    > 11 |         const apiKey = process.env.ELEVENLABS_API_KEY;
         |                 ^
      12 |         if (!apiKey) {
      13 |             console.warn('ELEVENLABS_API_KEY is not set. Using fallback/mock audio or returning error.');
      14 |             return NextResponse.json({ error: 'ElevenLabs API key is missing' }, { status: 500 });

      at Object.Request (node_modules/next/src/server/web/spec-extension/request.ts:14:34)
      at Object.<anonymous> (node_modules/next/server.js:2:16)
      at Object.<anonymous> (src/app/api/sfx/route.ts:11:17)
      at Object.<anonymous> (__tests__/api/sfx.test.ts:5:16)

FAIL __tests__/api/speak.test.ts
  â— Test suite failed to run

    ReferenceError: Request is not defined

       9 |         }
      10 |
    > 11 |         const apiKey = process.env.ELEVENLABS_API_KEY;
         |                 ^
      12 |         if (!apiKey) {
      13 |             console.warn('ELEVENLABS_API_KEY is not set. Using fallback/mock audio or returning error.');
      14 |             // For now, return a 500 error, or you can return a mock audio buffer if needed

      at Object.Request (node_modules/next/src/server/web/spec-extension/request.ts:14:34)
      at Object.<anonymous> (node_modules/next/server.js:2:16)
      at Object.<anonymous> (src/app/api/speak/route.ts:11:17)
      at Object.<anonymous> (__tests__/api/speak.test.ts:5:16)

PASS src/lib/__tests__/codeTransform.test.ts
PASS __tests__/components/ApiSetupModal.test.tsx
FAIL __tests__/lib/customBlocks.test.ts
  â— Console

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      40 |             const block = workspace.newBlock('magic_condition');
      41 |             block.setFieldValue('test prompt', 'PROMPT');
    > 42 |             const code = javascriptGenerator.blockToCode(block) as [string, number];
         |                                              ^
      43 |             expect(code[0]).toContain('/* âœ¨ AI CONDITION: "test prompt" */ true');
      44 |         });
      45 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:42:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      40 |             const block = workspace.newBlock('magic_condition');
      41 |             block.setFieldValue('test prompt', 'PROMPT');
    > 42 |             const code = javascriptGenerator.blockToCode(block) as [string, number];
         |                                              ^
      43 |             expect(code[0]).toContain('/* âœ¨ AI CONDITION: "test prompt" */ true');
      44 |         });
      45 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.blockToCode [as scrub_] (node_modules/blockly/generators/javascript/javascript_generator.ts:281:43)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.scrub_ [as blockToCode] (node_modules/blockly/core/generator.ts:274:20)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:42:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      48 |             block.setFieldValue('bg', 'TARGET');
      49 |             block.setFieldValue('red', 'PROMPT');
    > 50 |             const code = javascriptGenerator.blockToCode(block) as string;
         |                                              ^
      51 |             expect(code).toContain("AI_MAGIC_STYLE: bg -> red");
      52 |         });
      53 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:50:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      48 |             block.setFieldValue('bg', 'TARGET');
      49 |             block.setFieldValue('red', 'PROMPT');
    > 50 |             const code = javascriptGenerator.blockToCode(block) as string;
         |                                              ^
      51 |             expect(code).toContain("AI_MAGIC_STYLE: bg -> red");
      52 |         });
      53 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.blockToCode [as scrub_] (node_modules/blockly/generators/javascript/javascript_generator.ts:281:43)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.scrub_ [as blockToCode] (node_modules/blockly/core/generator.ts:282:19)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:50:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      57 |             block.setFieldValue(150, 'X');
      58 |             block.setFieldValue(200, 'Y');
    > 59 |             const code = javascriptGenerator.blockToCode(block) as string;
         |                                              ^
      60 |             expect(code).toContain('drawShape("circle", 150, 200)');
      61 |         });
      62 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:59:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      57 |             block.setFieldValue(150, 'X');
      58 |             block.setFieldValue(200, 'Y');
    > 59 |             const code = javascriptGenerator.blockToCode(block) as string;
         |                                              ^
      60 |             expect(code).toContain('drawShape("circle", 150, 200)');
      61 |         });
      62 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.blockToCode [as scrub_] (node_modules/blockly/generators/javascript/javascript_generator.ts:281:43)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.scrub_ [as blockToCode] (node_modules/blockly/core/generator.ts:282:19)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:59:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      66 |             block.setFieldValue(45, 'DIR');
      67 |             block.setFieldValue(10, 'POWER');
    > 68 |             const code = javascriptGenerator.blockToCode(block) as string;
         |                                              ^
      69 |             expect(code).toContain('applyForce("Player", 45, 10)');
      70 |         });
      71 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:68:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      66 |             block.setFieldValue(45, 'DIR');
      67 |             block.setFieldValue(10, 'POWER');
    > 68 |             const code = javascriptGenerator.blockToCode(block) as string;
         |                                              ^
      69 |             expect(code).toContain('applyForce("Player", 45, 10)');
      70 |         });
      71 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.blockToCode [as scrub_] (node_modules/blockly/generators/javascript/javascript_generator.ts:281:43)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.scrub_ [as blockToCode] (node_modules/blockly/core/generator.ts:282:19)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:68:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      73 |             const block = workspace.newBlock('timer_every');
      74 |             block.setFieldValue(5, 'SECONDS');
    > 75 |             const code = javascriptGenerator.blockToCode(block) as string;
         |                                              ^
      76 |             expect(code).toContain('setInterval(function() {');
      77 |             expect(code).toContain('}, 5000)');
      78 |         });

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:75:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      472 |     javascriptGenerator.forBlock['timer_every'] = function (block: any) {
      473 |         const seconds = block.getFieldValue('SECONDS');
    > 474 |         const branch = javascriptGenerator.statementToCode(block, 'STACK') || "";
          |                                            ^
      475 |         return `setInterval(function() {\n${branch}}, ${seconds * 1000});\n`;
      476 |     };
      477 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.blockToCode [as statementToCode] (node_modules/blockly/core/generator.ts:390:21)
      at Block$$module$build$src$core$block.statementToCode (src/lib/customBlocks.ts:474:44)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.call [as blockToCode] (node_modules/blockly/core/generator.ts:268:21)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:75:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      73 |             const block = workspace.newBlock('timer_every');
      74 |             block.setFieldValue(5, 'SECONDS');
    > 75 |             const code = javascriptGenerator.blockToCode(block) as string;
         |                                              ^
      76 |             expect(code).toContain('setInterval(function() {');
      77 |             expect(code).toContain('}, 5000)');
      78 |         });

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.blockToCode [as scrub_] (node_modules/blockly/generators/javascript/javascript_generator.ts:281:43)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.scrub_ [as blockToCode] (node_modules/blockly/core/generator.ts:282:19)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:75:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      82 |             block.setFieldValue('Hello', 'TEXT');
      83 |             block.setFieldValue('Hero', 'CHARACTER');
    > 84 |             const code = javascriptGenerator.blockToCode(block) as string;
         |                                              ^
      85 |             expect(code).toContain('speakText("Hello", "Hero")');
      86 |         });
      87 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:84:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      82 |             block.setFieldValue('Hello', 'TEXT');
      83 |             block.setFieldValue('Hero', 'CHARACTER');
    > 84 |             const code = javascriptGenerator.blockToCode(block) as string;
         |                                              ^
      85 |             expect(code).toContain('speakText("Hello", "Hero")');
      86 |         });
      87 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.blockToCode [as scrub_] (node_modules/blockly/generators/javascript/javascript_generator.ts:281:43)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.scrub_ [as blockToCode] (node_modules/blockly/core/generator.ts:282:19)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:84:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      90 |             block.setFieldValue('Hero', 'CHARACTER');
      91 |             block.setFieldValue('cute', 'STYLE');
    > 92 |             const code = javascriptGenerator.blockToCode(block) as string;
         |                                              ^
      93 |             expect(code).toContain('setVoiceStyle("Hero", "cute")');
      94 |         });
      95 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:92:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      90 |             block.setFieldValue('Hero', 'CHARACTER');
      91 |             block.setFieldValue('cute', 'STYLE');
    > 92 |             const code = javascriptGenerator.blockToCode(block) as string;
         |                                              ^
      93 |             expect(code).toContain('setVoiceStyle("Hero", "cute")');
      94 |         });
      95 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.blockToCode [as scrub_] (node_modules/blockly/generators/javascript/javascript_generator.ts:281:43)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.scrub_ [as blockToCode] (node_modules/blockly/core/generator.ts:282:19)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:92:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

       98 |             block.setFieldValue('damage', 'EVENT');
       99 |             block.setFieldValue('Ouch!', 'PROMPT');
    > 100 |             const code = javascriptGenerator.blockToCode(block) as string;
          |                                              ^
      101 |             expect(code).toContain('document.addEventListener("game_damage"');
      102 |             expect(code).toContain('reactWithVoice("Ouch!")');
      103 |         });

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:100:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

       98 |             block.setFieldValue('damage', 'EVENT');
       99 |             block.setFieldValue('Ouch!', 'PROMPT');
    > 100 |             const code = javascriptGenerator.blockToCode(block) as string;
          |                                              ^
      101 |             expect(code).toContain('document.addEventListener("game_damage"');
      102 |             expect(code).toContain('reactWithVoice("Ouch!")');
      103 |         });

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.blockToCode [as scrub_] (node_modules/blockly/generators/javascript/javascript_generator.ts:281:43)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.scrub_ [as blockToCode] (node_modules/blockly/core/generator.ts:282:19)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:100:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      106 |             const block = workspace.newBlock('magic_bgm_block');
      107 |             block.setFieldValue('tense battle', 'PROMPT');
    > 108 |             const code = javascriptGenerator.blockToCode(block) as string;
          |                                              ^
      109 |             expect(code).toContain('playBGM("tense battle")');
      110 |         });
      111 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:108:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      106 |             const block = workspace.newBlock('magic_bgm_block');
      107 |             block.setFieldValue('tense battle', 'PROMPT');
    > 108 |             const code = javascriptGenerator.blockToCode(block) as string;
          |                                              ^
      109 |             expect(code).toContain('playBGM("tense battle")');
      110 |         });
      111 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.blockToCode [as scrub_] (node_modules/blockly/generators/javascript/javascript_generator.ts:281:43)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.scrub_ [as blockToCode] (node_modules/blockly/core/generator.ts:282:19)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:108:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      113 |             const block = workspace.newBlock('play_sfx_block');
      114 |             block.setFieldValue('laser', 'PROMPT');
    > 115 |             const code = javascriptGenerator.blockToCode(block) as string;
          |                                              ^
      116 |             expect(code).toContain('playSFX("laser")');
      117 |         });
      118 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:115:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      113 |             const block = workspace.newBlock('play_sfx_block');
      114 |             block.setFieldValue('laser', 'PROMPT');
    > 115 |             const code = javascriptGenerator.blockToCode(block) as string;
          |                                              ^
      116 |             expect(code).toContain('playSFX("laser")');
      117 |         });
      118 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.blockToCode [as scrub_] (node_modules/blockly/generators/javascript/javascript_generator.ts:281:43)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.scrub_ [as blockToCode] (node_modules/blockly/core/generator.ts:282:19)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:115:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      120 |             const block = workspace.newBlock('remix_code_block');
      121 |             block.setFieldValue('make it faster', 'PROMPT');
    > 122 |             const code = javascriptGenerator.blockToCode(block) as string;
          |                                              ^
      123 |             expect(code).toContain('AI_MAGIC_REMIX: make it faster');
      124 |         });
      125 |

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:122:46)

    console.warn
      CodeGenerator init was not called before blockToCode was called.

      127 |             const block = workspace.newBlock('add_feature_block');
      128 |             block.setFieldValue('add a power-up', 'PROMPT');
    > 129 |             const code = javascriptGenerator.blockToCode(block) as string;
          |                                              ^
      130 |             expect(code).toContain('AI_MAGIC_ADD: add a power-up');
      131 |         });
      132 |     });

      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.warn [as blockToCode] (node_modules/blockly/core/generator.ts:239:15)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:129:46)

  â— Custom Blocks Integration â€º Generators â€º generates correct JS for remix_code_block

    TypeError: block.getSvgRoot is not a function

    [0m [90m 376 |[39m         [36mconst[39m escapedPrompt [33m=[39m prompt[33m.[39mreplace([35m/'/g[39m[33m,[39m [32m"\\'"[39m)[33m.[39mreplace([35m/"/g[39m[33m,[39m [32m'\\"'[39m)[33m;[39m
     [90m 377 |[39m         [36mconst[39m code [33m=[39m [32m`\n/* âœ¨ AI Request: REMIX CODE - "${escapedPrompt}" */\n{ console.log('AI_MAGIC_REMIX: ${escapedPrompt}'); }\n`[39m[33m;[39m
    [31m[1m>[22m[39m[90m 378 |[39m         [36mif[39m (block[33m.[39mgetSvgRoot()) block[33m.[39mgetSvgRoot()[33m.[39mclassList[33m.[39madd([32m'magic-block-glow'[39m)[33m;[39m
     [90m     |[39m                   [31m[1m^[22m[39m
     [90m 379 |[39m         [36mreturn[39m code[33m;[39m
     [90m 380 |[39m     }[33m;[39m
     [90m 381 |[39m[0m

      at Block$$module$build$src$core$block.getSvgRoot (src/lib/customBlocks.ts:378:19)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.call [as blockToCode] (node_modules/blockly/core/generator.ts:268:21)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:122:46)

  â— Custom Blocks Integration â€º Generators â€º generates correct JS for add_feature_block

    TypeError: block.getSvgRoot is not a function

    [0m [90m 384 |[39m         [36mconst[39m escapedPrompt [33m=[39m prompt[33m.[39mreplace([35m/'/g[39m[33m,[39m [32m"\\'"[39m)[33m.[39mreplace([35m/"/g[39m[33m,[39m [32m'\\"'[39m)[33m;[39m
     [90m 385 |[39m         [36mconst[39m code [33m=[39m [32m`\n/* âœ¨ AI Request: ADD FEATURE - "${escapedPrompt}" */\n{ console.log('AI_MAGIC_ADD: ${escapedPrompt}'); }\n`[39m[33m;[39m
    [31m[1m>[22m[39m[90m 386 |[39m         [36mif[39m (block[33m.[39mgetSvgRoot()) block[33m.[39mgetSvgRoot()[33m.[39mclassList[33m.[39madd([32m'magic-block-glow'[39m)[33m;[39m
     [90m     |[39m                   [31m[1m^[22m[39m
     [90m 387 |[39m         [36mreturn[39m code[33m;[39m
     [90m 388 |[39m     }[33m;[39m
     [90m 389 |[39m[0m

      at Block$$module$build$src$core$block.getSvgRoot (src/lib/customBlocks.ts:386:19)
      at JavascriptGenerator$$module$build$src$generators$javascript$javascript_generator.call [as blockToCode] (node_modules/blockly/core/generator.ts:268:21)
      at Object.blockToCode (__tests__/lib/customBlocks.test.ts:129:46)

Test Suites: 3 failed, 3 passed, 6 total
Tests:       2 failed, 45 passed, 47 total
Snapshots:   0 total
Time:        6.061 s
Ran all test suites.
